<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KeyGen ‚Äî G√©n√©rateur de cl√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="card" role="main">
    <h1>KeyGen ‚Äî G√©n√©rateur de cl√©s</h1>
    <p class="lead">G√©n√©rez, copiez et exportez des cl√©s d'activation. Les cl√©s sont stock√©es localement dans votre navigateur.</p>

    <section class="controls">
      <label for="prefix">Pr√©fixe (optionnel)</label>
      <input id="prefix" placeholder="EX: TRD-" />

      <div class="row">
        <div>
          <label for="partLength">Longueur d'une partie</label>
          <input id="partLength" type="number" min="3" value="5" />
        </div>
        <div>
          <label for="parts">Nombre de parties</label>
          <input id="parts" type="number" min="1" max="6" value="3" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="count">Nombre de cl√©s</label>
          <input id="count" type="number" min="1" max="500" value="5" />
        </div>
        <div>
          <label for="charset">Type</label>
          <select id="charset">
            <option value="alnum">Alphanum√©rique (A-Z0-9)</option>
            <option value="alpha">Lettres (A-Z)</option>
            <option value="numeric">Chiffres (0-9)</option>
            <option value="hex">Hexad√©cimal (0-9A-F)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="generate" type="button">G√©n√©rer</button>
        <button id="clear" type="button">Effacer</button>
        <button id="export" type="button">Exporter (.csv)</button>
      </div>
    </section>

    <section id="list" class="list" aria-live="polite"></section>
  </main>

  <script>
    const prefixEl = document.getElementById('prefix');
    const partLengthEl = document.getElementById('partLength');
    const partsEl = document.getElementById('parts');
    const countEl = document.getElementById('count');
    const charsetEl = document.getElementById('charset');
    const generateBtn = document.getElementById('generate');
    const clearBtn = document.getElementById('clear');
    const exportBtn = document.getElementById('export');
    const listEl = document.getElementById('list');

    const STORAGE_KEY = 'keygen_keys_v2';

    function getCharset(type) {
      switch (type) {
        case 'alpha': return 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        case 'numeric': return '0123456789';
        case 'hex': return '0123456789ABCDEF';
        default: return 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      }
    }

    function randomString(length, chars) {
      return Array.from(crypto.getRandomValues(new Uint8Array(length)))
        .map(n => chars[n % chars.length])
        .join('');
    }

    function makeKey(prefix, partLen, parts, chars) {
      const segments = Array.from({ length: parts }, () => randomString(partLen, chars));
      return prefix ? `${prefix.toUpperCase()}-${segments.join('-')}` : segments.join('-');
    }

    function loadKeys() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveKeys(keys) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(keys));
    }

    function render() {
      const keys = loadKeys();
      listEl.innerHTML = keys.length
        ? keys.map(k => `
          <div class="item">
            <span style="word-break:break-all">${k}</span>
            <div class="actions">
              <button onclick="navigator.clipboard.writeText('${k}')">üìã</button>
              <button onclick="deleteKey('${k}')">üóëÔ∏è</button>
            </div>
          </div>`).join('')
        : '<p class="small muted">Aucune cl√© g√©n√©r√©e.</p>';
    }

    function deleteKey(key) {
      const keys = loadKeys().filter(k => k !== key);
      saveKeys(keys);
      render();
    }

    generateBtn.addEventListener('click', () => {
      const prefix = prefixEl.value.trim();
      const partLen = Math.max(3, parseInt(partLengthEl.value) || 5);
      const parts = Math.min(6, Math.max(1, parseInt(partsEl.value) || 3));
      const count = Math.min(500, Math.max(1, parseInt(countEl.value) || 1));
      const chars = getCharset(charsetEl.value);

      const keys = loadKeys();
      for (let i = 0; i < count; i++) {
        keys.push(makeKey(prefix, partLen, parts, chars));
      }
      saveKeys(keys);
      render();
    });

    clearBtn.addEventListener('click', () => {
      if (confirm('Effacer toutes les cl√©s ?')) {
        localStorage.removeItem(STORAGE_KEY);
        render();
      }
    });

    exportBtn.addEventListener('click', () => {
      const keys = loadKeys();
      if (!keys.length) return alert('Aucune cl√© √† exporter.');
      const csv = keys.map(k => `"${k}"`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `keys_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Initial render
    render();
  </script>
</body>
</html>